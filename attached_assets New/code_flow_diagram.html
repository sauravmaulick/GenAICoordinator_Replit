<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Agent GenAI System - Code Flow Diagram</title>
    <script src="https://unpkg.com/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
        }
        .header p {
            margin: 10px 0 0 0;
            font-size: 1.2em;
            opacity: 0.9;
        }
        .content {
            padding: 30px;
        }
        .diagram-section {
            margin-bottom: 40px;
        }
        .diagram-section h2 {
            color: #333;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .mermaid {
            text-align: center;
            margin: 20px 0;
        }
        .architecture-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .component-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            transition: transform 0.3s ease;
        }
        .component-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .component-card h3 {
            color: #667eea;
            margin-top: 0;
            font-size: 1.3em;
        }
        .component-card ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        .component-card li {
            margin: 5px 0;
            color: #666;
        }
        .flow-steps {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin: 20px 0;
        }
        .flow-steps h3 {
            color: #333;
            margin-top: 0;
        }
        .step {
            display: flex;
            align-items: center;
            margin: 15px 0;
            padding: 10px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        .step-number {
            background: #667eea;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
            flex-shrink: 0;
        }
        .legend {
            background: #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        .legend h3 {
            margin-top: 0;
            color: #333;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß¨ Multi-Agent GenAI System</h1>
            <p>Comprehensive Code Flow Diagram - Pharmaceutical Data Analysis Platform</p>
        </div>
        
        <div class="content">
            <!-- Overall System Architecture -->
            <div class="diagram-section">
                <h2>üèóÔ∏è Overall System Architecture</h2>
                <div class="mermaid">
                    graph TB
                        subgraph "Frontend Layer"
                            ST[Streamlit App<br/>streamlit_app.py]
                        end
                        
                        subgraph "Orchestration Layer"
                            WF[MultiAgentWorkflow<br/>run_langgraph.py]
                            LG[LangGraph StateGraph<br/>Workflow Engine]
                        end
                        
                        subgraph "Agent Layer"
                            ORC[Orchestrator Agent<br/>Chain-of-Thought Reasoning]
                            CAPA[CAPA Agent<br/>File Processing]
                            NEO[Neo4j Agent<br/>Graph Queries]
                            VEC[Vector Agent<br/>Similarity Search]
                            EMAIL[Email Agent<br/>Communication]
                        end
                        
                        subgraph "MCP Module Layer"
                            MCP_CAPA[mcp_capa.py<br/>Text File Handler]
                            MCP_NEO[mcp_neo4j.py<br/>Graph DB Interface]
                            MCP_VEC[mcp_vector.py<br/>Vector DB Interface]
                            MCP_EMAIL[mcp_email.py<br/>SMTP Handler]
                        end
                        
                        subgraph "Data Layer"
                            CAPA_DATA[CAPA Data Files<br/>data/capa_data.txt]
                            NEO_DB[Neo4j Database<br/>Investigation-CAPA-Brand]
                            VEC_DB[Vector Database<br/>Embedded Clinical Trials]
                            SMTP[SMTP Server<br/>Email Delivery]
                        end
                        
                        subgraph "AI/ML Layer"
                            GEMINI[Google Gemini API<br/>LLM + Embeddings]
                            EMB[Embeddings Handler<br/>models/embeddings_handler.py]
                        end
                        
                        ST --> WF
                        WF --> LG
                        LG --> ORC
                        LG --> CAPA
                        LG --> NEO
                        LG --> VEC
                        LG --> EMAIL
                        
                        CAPA --> MCP_CAPA
                        NEO --> MCP_NEO
                        VEC --> MCP_VEC
                        EMAIL --> MCP_EMAIL
                        
                        MCP_CAPA --> CAPA_DATA
                        MCP_NEO --> NEO_DB
                        MCP_VEC --> VEC_DB
                        MCP_EMAIL --> SMTP
                        
                        ORC --> GEMINI
                        VEC --> EMB
                        EMB --> GEMINI
                        
                        classDef frontend fill:#e1f5fe
                        classDef orchestration fill:#f3e5f5
                        classDef agent fill:#e8f5e8
                        classDef mcp fill:#fff3e0
                        classDef data fill:#fce4ec
                        classDef ai fill:#f1f8e9
                        
                        class ST frontend
                        class WF,LG orchestration
                        class ORC,CAPA,NEO,VEC,EMAIL agent
                        class MCP_CAPA,MCP_NEO,MCP_VEC,MCP_EMAIL mcp
                        class CAPA_DATA,NEO_DB,VEC_DB,SMTP data
                        class GEMINI,EMB ai
                </div>
            </div>

            <!-- Detailed Workflow Execution -->
            <div class="diagram-section">
                <h2>üîÑ LangGraph Workflow Execution Flow</h2>
                <div class="mermaid">
                    flowchart TD
                        START([User Query Input]) --> INIT[Initialize WorkflowState]
                        INIT --> ORCH[Orchestrator Node<br/>Query Breakdown]
                        
                        ORCH --> BREAKDOWN{Query Analysis<br/>Chain-of-Thought}
                        BREAKDOWN --> SUB1[Sub-Question 1:<br/>CAPA Analysis]
                        BREAKDOWN --> SUB2[Sub-Question 2:<br/>Neo4j Investigation]
                        BREAKDOWN --> SUB3[Sub-Question 3:<br/>Vector Search]
                        
                        SUB1 --> CAPA_NODE[CAPA Agent Node]
                        SUB2 --> NEO_NODE[Neo4j Agent Node]
                        SUB3 --> VEC_NODE[Vector Agent Node]
                        
                        CAPA_NODE --> CAPA_PROC[Process CAPA Files<br/>Filter by Date/Status]
                        NEO_NODE --> NEO_PROC[Query Graph Database<br/>Investigation-Brand Links]
                        VEC_NODE --> VEC_PROC[Vector Similarity Search<br/>Clinical Trial Docs]
                        
                        CAPA_PROC --> CONSOLIDATE[Consolidate Results Node]
                        NEO_PROC --> CONSOLIDATE
                        VEC_PROC --> CONSOLIDATE
                        
                        CONSOLIDATE --> SUMMARY[Generate Final Summary<br/>using Gemini]
                        SUMMARY --> EMAIL_CHECK{Email Requested?}
                        
                        EMAIL_CHECK -->|Yes| EMAIL_NODE[Email Agent Node]
                        EMAIL_CHECK -->|No| END_SUCCESS([Workflow Complete])
                        
                        EMAIL_NODE --> EMAIL_SEND[Send Summary Email<br/>with Human Approval]
                        EMAIL_SEND --> END_SUCCESS
                        
                        classDef startEnd fill:#e8f5e8,stroke:#4caf50,stroke-width:3px
                        classDef process fill:#e3f2fd,stroke:#2196f3,stroke-width:2px
                        classDef agent fill:#fff3e0,stroke:#ff9800,stroke-width:2px
                        classDef decision fill:#fce4ec,stroke:#e91e63,stroke-width:2px
                        
                        class START,END_SUCCESS startEnd
                        class INIT,BREAKDOWN,CAPA_PROC,NEO_PROC,VEC_PROC,CONSOLIDATE,SUMMARY,EMAIL_SEND process
                        class ORCH,CAPA_NODE,NEO_NODE,VEC_NODE,EMAIL_NODE agent
                        class EMAIL_CHECK decision
                </div>
            </div>

            <!-- Component Details -->
            <div class="diagram-section">
                <h2>üß© System Components</h2>
                <div class="architecture-grid">
                    <div class="component-card">
                        <h3>üéØ Orchestrator Agent</h3>
                        <ul>
                            <li>Uses Gemini 2.5-flash for CoT reasoning</li>
                            <li>Breaks queries into 3 specialized sub-questions</li>
                            <li>Coordinates overall workflow execution</li>
                            <li>Generates final consolidated summaries</li>
                        </ul>
                    </div>
                    
                    <div class="component-card">
                        <h3>üìä CAPA Agent</h3>
                        <ul>
                            <li>Processes Corrective/Preventive Action files</li>
                            <li>Filters by status, date, and other criteria</li>
                            <li>Counts open/closed CAPAs by timeframe</li>
                            <li>Extracts relevant compliance data</li>
                        </ul>
                    </div>
                    
                    <div class="component-card">
                        <h3>üîó Neo4j Agent</h3>
                        <ul>
                            <li>Queries graph database relationships</li>
                            <li>Links Investigations ‚Üî CAPAs ‚Üî Brands</li>
                            <li>Finds connected entities and patterns</li>
                            <li>Mock implementation for development</li>
                        </ul>
                    </div>
                    
                    <div class="component-card">
                        <h3>üîç Vector Agent</h3>
                        <ul>
                            <li>Performs similarity search on embeddings</li>
                            <li>Searches clinical trial documents</li>
                            <li>Uses Gemini embeddings with fallback</li>
                            <li>Filters by brand and content type</li>
                        </ul>
                    </div>
                    
                    <div class="component-card">
                        <h3>üìß Email Agent</h3>
                        <ul>
                            <li>Sends consolidated analysis summaries</li>
                            <li>Human-in-the-loop approval workflow</li>
                            <li>SMTP integration with mock mode</li>
                            <li>Email logging and tracking</li>
                        </ul>
                    </div>
                    
                    <div class="component-card">
                        <h3>ü§ñ Embeddings Handler</h3>
                        <ul>
                            <li>Google Gemini text embeddings</li>
                            <li>Fallback to sentence-transformers</li>
                            <li>Vector similarity calculations</li>
                            <li>Summary generation with LLM</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Data Flow Process -->
            <div class="flow-steps">
                <h3>üìã Detailed Data Flow Process</h3>
                
                <div class="step">
                    <div class="step-number">1</div>
                    <div>
                        <strong>Query Input:</strong> User enters complex pharmaceutical query via Streamlit interface. 
                        Session state initialized with workflow tracking variables.
                    </div>
                </div>
                
                <div class="step">
                    <div class="step-number">2</div>
                    <div>
                        <strong>Orchestrator Analysis:</strong> Gemini 2.5-flash processes query using Chain-of-Thought reasoning, 
                        breaking it into exactly 3 specialized sub-questions for different data sources.
                    </div>
                </div>
                
                <div class="step">
                    <div class="step-number">3</div>
                    <div>
                        <strong>Parallel Agent Execution:</strong> LangGraph coordinates parallel execution of CAPA Agent 
                        (file processing), Neo4j Agent (graph queries), and Vector Agent (similarity search).
                    </div>
                </div>
                
                <div class="step">
                    <div class="step-number">4</div>
                    <div>
                        <strong>CAPA Processing:</strong> Agent reads tab-separated CAPA data file, filters by status and 
                        date ranges, counts open/closed actions, and extracts compliance metrics.
                    </div>
                </div>
                
                <div class="step">
                    <div class="step-number">5</div>
                    <div>
                        <strong>Neo4j Querying:</strong> Agent executes Cypher queries on graph database to find 
                        Investigation-CAPA-Brand relationships and connected entity patterns.
                    </div>
                </div>
                
                <div class="step">
                    <div class="step-number">6</div>
                    <div>
                        <strong>Vector Search:</strong> Agent generates embeddings for query text, performs similarity 
                        search on clinical trial documents, and filters results by brand and relevance.
                    </div>
                </div>
                
                <div class="step">
                    <div class="step-number">7</div>
                    <div>
                        <strong>Result Consolidation:</strong> Orchestrator combines all agent results using Gemini to 
                        generate comprehensive, contextual summary addressing original query.
                    </div>
                </div>
                
                <div class="step">
                    <div class="step-number">8</div>
                    <div>
                        <strong>Human Review:</strong> Streamlit displays consolidated results in real-time. User reviews 
                        analysis and optionally approves email delivery to stakeholders.
                    </div>
                </div>
                
                <div class="step">
                    <div class="step-number">9</div>
                    <div>
                        <strong>Email Delivery:</strong> If approved, Email Agent sends formatted summary via SMTP with 
                        logging and tracking. Mock mode available for development testing.
                    </div>
                </div>
            </div>

            <!-- File Structure -->
            <div class="diagram-section">
                <h2>üìÅ File Structure & Relationships</h2>
                <div class="mermaid">
                    graph LR
                        subgraph "Main Application"
                            APP[streamlit_app.py<br/>Main UI Interface]
                            WF[run_langgraph.py<br/>Workflow Controller]
                        end
                        
                        subgraph "agents/"
                            ORC[orchestrator.py<br/>Query Breakdown]
                            CAPA[capa_agent.py<br/>File Processing]
                            NEO[neo4j_agent.py<br/>Graph Queries]
                            VEC[vector_agent.py<br/>Similarity Search]
                            EMAIL[email_agent.py<br/>Communication]
                        end
                        
                        subgraph "mcp_modules/"
                            MCP_C[mcp_capa.py<br/>Text File I/O]
                            MCP_N[mcp_neo4j.py<br/>Graph DB API]
                            MCP_V[mcp_vector.py<br/>Vector DB API]
                            MCP_E[mcp_email.py<br/>SMTP Interface]
                        end
                        
                        subgraph "models/"
                            EMB[embeddings_handler.py<br/>AI/ML Operations]
                        end
                        
                        subgraph "utils/"
                            CONFIG[config.py<br/>Settings]
                            LOG[logging_config.py<br/>Log Management]
                        end
                        
                        subgraph "data/"
                            CAPA_DATA[capa_data.txt<br/>Sample Data]
                        end
                        
                        APP --> WF
                        WF --> ORC
                        WF --> CAPA
                        WF --> NEO
                        WF --> VEC
                        WF --> EMAIL
                        
                        CAPA --> MCP_C
                        NEO --> MCP_N
                        VEC --> MCP_V
                        EMAIL --> MCP_E
                        
                        VEC --> EMB
                        ORC --> EMB
                        
                        MCP_C --> CAPA_DATA
                        
                        classDef main fill:#e1f5fe
                        classDef agents fill:#e8f5e8
                        classDef mcp fill:#fff3e0
                        classDef models fill:#f1f8e9
                        classDef utils fill:#fce4ec
                        classDef data fill:#f3e5f5
                        
                        class APP,WF main
                        class ORC,CAPA,NEO,VEC,EMAIL agents
                        class MCP_C,MCP_N,MCP_V,MCP_E mcp
                        class EMB models
                        class CONFIG,LOG utils
                        class CAPA_DATA data
                </div>
            </div>

            <!-- Technology Stack -->
            <div class="diagram-section">
                <h2>üõ†Ô∏è Technology Stack & Integration</h2>
                <div class="mermaid">
                    graph TB
                        subgraph "Frontend Framework"
                            ST[Streamlit<br/>Web Interface]
                        end
                        
                        subgraph "Workflow Orchestration"
                            LG[LangGraph<br/>State Management]
                            ASYNC[AsyncIO<br/>Concurrent Processing]
                        end
                        
                        subgraph "AI/ML Services"
                            GEMINI[Google Gemini API<br/>LLM + Embeddings]
                            FALLBACK[Sentence Transformers<br/>Fallback Embeddings]
                        end
                        
                        subgraph "Data Storage"
                            NEO4J[Neo4j Graph DB<br/>Relationships]
                            VECTOR[Astra DB<br/>Vector Storage]
                            FILES[Text Files<br/>CAPA Data]
                        end
                        
                        subgraph "Communication"
                            SMTP[SMTP Server<br/>Email Delivery]
                            LOGS[File Logging<br/>Audit Trail]
                        end
                        
                        subgraph "Development Tools"
                            MOCK[Mock Implementations<br/>Development Mode]
                            ENV[Environment Variables<br/>Configuration]
                        end
                        
                        ST --> LG
                        LG --> ASYNC
                        ASYNC --> GEMINI
                        GEMINI --> FALLBACK
                        
                        LG --> NEO4J
                        LG --> VECTOR
                        LG --> FILES
                        LG --> SMTP
                        LG --> LOGS
                        
                        MOCK --> NEO4J
                        MOCK --> VECTOR
                        MOCK --> SMTP
                        ENV --> GEMINI
                        
                        classDef frontend fill:#e1f5fe
                        classDef workflow fill:#f3e5f5
                        classDef ai fill:#e8f5e8
                        classDef data fill:#fff3e0
                        classDef comm fill:#fce4ec
                        classDef dev fill:#f1f8e9
                        
                        class ST frontend
                        class LG,ASYNC workflow
                        class GEMINI,FALLBACK ai
                        class NEO4J,VECTOR,FILES data
                        class SMTP,LOGS comm
                        class MOCK,ENV dev
                </div>
            </div>

            <!-- Legend -->
            <div class="legend">
                <h3>üè∑Ô∏è Legend</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #e1f5fe;"></div>
                        <span>Frontend Layer</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #f3e5f5;"></div>
                        <span>Orchestration Layer</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #e8f5e8;"></div>
                        <span>Agent Layer</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #fff3e0;"></div>
                        <span>MCP Module Layer</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #fce4ec;"></div>
                        <span>Data Layer</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #f1f8e9;"></div>
                        <span>AI/ML Layer</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            },
            themeVariables: {
                primaryColor: '#667eea',
                primaryTextColor: '#333',
                primaryBorderColor: '#667eea',
                lineColor: '#666',
                secondaryColor: '#f8f9fa',
                tertiaryColor: '#e9ecef'
            }
        });
    </script>
</body>
</html>